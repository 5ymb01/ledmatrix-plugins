# LEDMatrix Plugin Development Rules

## Monorepo Structure

All official plugins live in `plugins/<plugin-id>/` within this repository.
The registry file `plugins.json` is the source of truth for the Plugin Store.

## Plugin Version Management

### When Making Changes to Any Plugin

**ALWAYS follow this exact sequence:**

#### 1. Update Plugin Files
- Make your code changes in `plugins/<plugin-id>/`
- Files: `manager.py`, `config_schema.json`, etc.

#### 2. Bump Version in `manifest.json`
- **Bump the `version` field** using semantic versioning (MAJOR.MINOR.PATCH)
- Update the `versions` array — add the NEW version FIRST (most recent at top):
  ```json
  "version": "1.2.3",

  "versions": [
    {
      "released": "2026-02-11",
      "version": "1.2.3",
      "ledmatrix_min": "2.0.0"
    },
    {
      "released": "2025-10-20",
      "version": "1.2.2",
      ...
    }
  ]
  ```

#### 3. Commit
- The **pre-commit hook** automatically runs `update_registry.py` and stages `plugins.json`
- You do NOT need to manually run `update_registry.py` or manually edit `plugins.json`

```bash
git add plugins/<plugin-id>/
git commit -m "fix(plugin-id): description of change"
git push origin main
```

**If the pre-commit hook is not installed:** `cp scripts/pre-commit .git/hooks/pre-commit`

---

## Version Numbering Guidelines

### When to Bump MAJOR (x.0.0)
- Breaking changes to config schema (not backward compatible)
- Removed features or config options
- Complete rewrite or architecture change

### When to Bump MINOR (1.x.0)
- New features added
- New config options (backward compatible)
- New display modes or functionality

### When to Bump PATCH (1.2.x)
- Bug fixes
- Performance improvements
- Documentation updates
- Minor tweaks

---

## Common Pitfalls

### Forgetting to Bump Version
**Problem**: Users won't receive the update — the store compares `manifest.json` version against `plugins.json` `latest_version`.
**Solution**: Always bump `version` in `manifest.json` for every change.

### Version Mismatch
**Problem**: `version` field doesn't match top entry in `versions` array.
**Solution**: Keep both in sync.

---

## Plugin Manifest Required Fields

Every `plugins/<id>/manifest.json` must have:
- `id` — Plugin identifier (must match directory name)
- `name` — Human-readable display name
- `version` — Semver string (e.g., "1.2.3")
- `class_name` — Python class name in manager.py
- `display_modes` — Array of supported display modes

## Registry Format

`plugins.json` entries for monorepo plugins use:
- `repo`: `https://github.com/ChuckBuilds/ledmatrix-plugins`
- `plugin_path`: `plugins/<plugin-id>`
- `branch`: `main`
- `latest_version`: Synced from manifest by `update_registry.py`

Third-party plugins keep their own `repo` URL and empty `plugin_path`.

---

## Checklist

Before pushing a plugin update:

- [ ] Code changes completed and tested
- [ ] `manifest.json` version bumped
- [ ] New version added to TOP of `versions` array
- [ ] Pre-commit hook installed (`cp scripts/pre-commit .git/hooks/pre-commit`)
- [ ] Committed and pushed

---

## Integration with LEDMatrix Core

When updating the **LEDMatrix core** (not plugins), you don't need to update the registry.

But if you update:
- `plugin_system/base_plugin.py`
- `web_interface/templates/v3/partials/plugins.html`
- API endpoints used by plugins

**Then** you should:
1. Test all installed plugins still work
2. Update minimum LEDMatrix version in affected plugin manifests
3. Document breaking changes
